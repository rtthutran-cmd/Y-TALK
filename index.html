<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Y-TALK - Conversation Buddy</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, html, #root {
      height: 100%;
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    const Send = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );
    
    const RotateCcw = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="1 4 1 10 7 10"></polyline>
        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
      </svg>
    );

    const ConversationCoach = () => {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [conversationState, setConversationState] = useState({
        step: 'welcome',
        adult: null,
        problem_description: null,
        problem_theme: null,
        observation_text_raw: null,
        thought_text_raw: null,
        feeling_text_raw: null,
        want_text_raw: null,
        feeling_reasoning: null,
        has_observation: false,
        has_thought: false,
        has_feeling: false,
        has_want: false,
        needs_feeling_reasoning: false,
        talked_before: null,
        talked_before_detected: false,
        went_well: null,
        branch: null,
        currentTipSection: null,
        shownTipsBefore: false,
        shownTipsDuring: false,
        shownHandlingResponses: false,
        currentSubStep: null,
        pendingMessages: [],
        isMentalHealth: false
      });
      
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      useEffect(() => {
        addBotMessage("Hey astronaut ðŸ§‘â€ðŸš€! Want to talk to an adult and don't know what to say? I can help you write a draft.\n\nLots of people find it hard to start a conversation, but we can always prepare and practice.\n\nTo begin, tell me, who would you like to talk to?");
      }, []);

      const resetConversation = () => {
        setMessages([]);
        setConversationState({
          step: 'welcome',
          adult: null,
          problem_description: null,
          problem_theme: null,
          observation_text_raw: null,
          thought_text_raw: null,
          feeling_text_raw: null,
          want_text_raw: null,
          feeling_reasoning: null,
          has_observation: false,
          has_thought: false,
          has_feeling: false,
          has_want: false,
          needs_feeling_reasoning: false,
          talked_before: null,
          talked_before_detected: false,
          went_well: null,
          branch: null,
          currentTipSection: null,
          shownTipsBefore: false,
          shownTipsDuring: false,
          shownHandlingResponses: false,
          currentSubStep: null,
          pendingMessages: [],
          isMentalHealth: false
        });
        addBotMessage("Hey astronaut ðŸ§‘â€ðŸš€! Want to talk to an adult and don't know what to say? I can help you write a draft.\n\nLots of people find it hard to start a conversation, but we can always prepare and practice.\n\nTo begin, tell me, who would you like to talk to?");
      };

      const addBotMessage = (text) => {
        setMessages(prev => [...prev, { 
          type: 'bot', 
          text, 
          timestamp: Date.now() 
        }]);
      };

      const addUserMessage = (text) => {
        setMessages(prev => [...prev, { 
          type: 'user', 
          text, 
          timestamp: Date.now() 
        }]);
      };

      const handleSend = () => {
        if (!input.trim() || isLoading) return;
        
        const userMessage = input.trim();
        addUserMessage(userMessage);
        setInput('');
        
        const updatedPending = [...conversationState.pendingMessages, userMessage];
        setConversationState(prev => ({
          ...prev,
          pendingMessages: updatedPending
        }));

        processMessages(updatedPending);
        
        setTimeout(() => {
          if (inputRef.current) {
            inputRef.current.focus();
          }
        }, 100);
      };

      const processMessages = async (pendingMessages) => {
        if (pendingMessages.length === 0) return;
        
        setIsLoading(true);
        const combinedMessage = pendingMessages.join('\n');
        
        try {
          const systemPrompt = buildSystemPrompt();
          const conversationHistory = buildConversationHistory(combinedMessage);
          
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              system: systemPrompt,
              messages: conversationHistory
            })
          });

          const data = await response.json();
          
          if (data.error) {
            console.error('API Error:', data.error);
            addBotMessage("Sorry, I'm having trouble connecting right now. Can you try again?");
            setIsLoading(false);
            return;
          }
          
          if (!data.content || !Array.isArray(data.content)) {
            console.error('Invalid API response:', data);
            addBotMessage("Sorry, I'm having trouble connecting right now. Can you try again?");
            setIsLoading(false);
            return;
          }
          
          const botResponse = data.content.map(item => item.type === 'text' ? item.text : '').join('\n');
          
          const newState = parseAndUpdateState(botResponse, combinedMessage);
          setConversationState(prev => ({
            ...prev,
            ...newState,
            pendingMessages: []
          }));
          
          addBotMessage(botResponse);
          
        } catch (error) {
          console.error('API Error:', error);
          addBotMessage("Sorry, I'm having trouble connecting right now. Can you try again?");
        } finally {
          setIsLoading(false);
          setTimeout(() => {
            if (inputRef.current) {
              inputRef.current.focus();
            }
          }, 100);
        }
      };

      const buildSystemPrompt = () => {
        const basePrompt = `You are a warm, empathetic conversation coach helping middle school and high school students prepare to talk to adults. Your tone is like a supportive older sibling - warm, non-judgmental, and encouraging. Use simple language. Be encouraging but not overly validating - keep it chill and genuine.

Current conversation state:
- Step: ${conversationState.step}
- Adult: ${conversationState.adult || 'not identified'}
- Problem: ${conversationState.problem_description || 'not identified'}
- Theme: ${conversationState.problem_theme || 'not identified'}
- Mental health conversation: ${conversationState.isMentalHealth}

Whole Message parts collected:
- Observation: ${conversationState.observation_text_raw || 'not yet'} (has: ${conversationState.has_observation})
- Thought: ${conversationState.thought_text_raw || 'not yet'} (has: ${conversationState.has_thought})
- Feeling: ${conversationState.feeling_text_raw || 'not yet'} (has: ${conversationState.has_feeling})
- Feeling reasoning: ${conversationState.feeling_reasoning || 'not yet'}
- Want: ${conversationState.want_text_raw || 'not yet'} (has: ${conversationState.has_want})
- Talked before: ${conversationState.talked_before || 'not detected'} (detected: ${conversationState.talked_before_detected})
- Went well: ${conversationState.went_well || 'not known'}
- Branch: ${conversationState.branch || 'not determined'}
- Tips shown: Before=${conversationState.shownTipsBefore}, During=${conversationState.shownTipsDuring}, Handling=${conversationState.shownHandlingResponses}

Guidelines:
1. Keep responses concise (2-4 sentences usually)
2. Ask one question at a time
3. Use casual language ("Aight!", "Okie!", "Got it")
4. Never be judgmental

Step-specific instructions:`;

        if (conversationState.step === 'welcome' || conversationState.step === 'identification') {
          return basePrompt + `
You're in the identification phase. Help the user identify:
1. WHO they want to talk to (adult)
2. WHAT they want to talk about (problem)

Responses to look for:
- Adults: teacher, mom, dad, parent, brother, sister, principal, doctor, nurse, boss, cousin, aunt, uncle, grandma, grandpa, coach
- Problem themes: school, family, friends, future, self, wants
- Mental health keywords: depressed, anxious, self-harm, suicide, therapist, counselor, psychologist, hurt myself

If user only gives one (adult OR problem), ask for the other.
If response is vague ("everything sucks"), gently ask them to pick one specific thing.

Once you have BOTH adult and problem:
- Summarize: "Got it. You're planning to talk to your [adult] about [theme]."
- Then IMMEDIATELY transition by saying EXACTLY:

"There's something called the **Whole Message Approach**. In a whole message, you say:
â€¢ **What happened**
â€¢ **What do you think** about the situation
â€¢ **How do you feel** about the situation
â€¢ **What you want** to happen

First, what happened? Tell me whatever you're comfortable with sharing."`;
        }

        if (conversationState.step === 'initial_story') {
          return basePrompt + `
The user just answered "what happened" with their initial story. You need to:

1. ANALYZE their response and detect which Whole Message parts they mentioned:
   - Observation (what happened - facts, events)
   - Thought (what they think about it - opinions, interpretations)
   - Feeling (ANY emotion mentioned - scared, mad, sad, worried, frustrated, angry, nervous, etc.)
   - Want (what they want to happen - goals, outcomes)

2. ALSO detect if they've mentioned talking to this adult before:
   - Look for phrases like: "last time I talked to...", "when I brought this up before...", "I've never talked to them about...", "this is the first time...", "they yelled at me before", "we talked about this already"
   - If detected, note whether it went well or poorly

CRITICAL: If they mention ANY emotion word at all (even just one word like "scared" or "worried"), that counts as having a Feeling. Do NOT ask for more feelings or "what other feelings." Just mark it as detected and move on.

3. Provide brief validation (1 sentence like "I can see why this is frustrating" or "That makes sense")

4. Move to asking for the FIRST missing part (ask ONE question only):
   - If missing Thought: "What do you think about this situation?"
   - If missing Feeling: "How does this make you feel?"
   - If missing Want: "What do you want to happen when you talk to [adult]?"
   
IMPORTANT: Only ask for ONE missing part. Do NOT ask for elaboration or "other feelings" if they already mentioned one. Just move to the next missing part.

If they provided ALL four parts, continue to next phase.`;
        }

        if (conversationState.step === 'collecting_thought') {
          return basePrompt + `
You're collecting the missing THOUGHT part. 

The user just answered your question about what they think.

ALSO check if they mention talking to the adult before in their response.

If they mention ANY emotion in their response (scared, worried, mad, sad, etc.), that counts as also providing the Feeling. Do NOT ask "how do you feel" or "what other feelings" - just note it and move on.

If user provides thought: Acknowledge briefly ("Got it") and ask for the next missing part.
If user declines ("idk", "I don't know", "I'd rather not say"): Say "That's ok, sometimes it's hard to think about. Let's move on." Then ask for next missing part.

Only ask ONE question at a time for the next missing part.`;
        }

        if (conversationState.step === 'collecting_feeling') {
          return basePrompt + `
You're collecting the missing FEELING part.

The user just answered how they feel.

If they provide a feeling, check if they also explain WHY they feel that way (the reasoning/cause).
- If they say "I feel scared because he yelled last time" â†’ You have both feeling AND reasoning
- If they just say "scared" or "I feel nervous" â†’ You have feeling but need to ask for reasoning

If user provides feeling WITH clear reasoning: Acknowledge briefly ("Got it") and ask for the next missing part.
If user provides feeling WITHOUT reasoning: Ask "Why do you feel [emotion]?" or "What makes you feel that way?"
If user declines: Say "Okie." Then ask for next missing part.

Only ask ONE question at a time.`;
        }

        if (conversationState.step === 'collecting_want') {
          return basePrompt + `
You're collecting the missing WANT part.

If user provides it: Acknowledge briefly ("Got it") and move to summary.
If user declines: Say "Alright. Just know that when you have an end-goal for how you want this conversation to go, it is easier to plan what to say." Then move to summary.`;
        }

        if (conversationState.step === 'feeling_reasoning') {
          return basePrompt + `
You need to understand WHY the user feels this way.

Ask: "Why do you feel [emotion]?" or "What makes you feel that way?"

Once they answer, acknowledge and move to the next missing part or summary.`;
        }

        if (conversationState.step === 'show_summary') {
          const talkedBefore = conversationState.talked_before;
          const detected = conversationState.talked_before_detected;
          
          if (detected && talkedBefore === 'yes') {
            return basePrompt + `
The user mentioned earlier that they've talked to ${conversationState.adult} about this before.

Show summary and acknowledge they mentioned this:

"Here's what we have for your Whole Message:
â€¢ Observation: ${conversationState.observation_text_raw || 'not provided'}
â€¢ Thought: ${conversationState.thought_text_raw || 'not provided'}
â€¢ Feeling: ${conversationState.feeling_text_raw || 'not provided'}
â€¢ Want: ${conversationState.want_text_raw || 'not provided'}"

${conversationState.has_observation && conversationState.has_thought && conversationState.has_feeling && conversationState.has_want ? '' : 'This is a good start! Just know that the more details you can share with [adult], the better they\'ll be able to understand and help you.'}

Then say: "I noticed you mentioned talking to your ${conversationState.adult} about this before. How did that conversation go?"

Wait for their response to determine if it went well or not.`;
          } else if (detected && talkedBefore === 'no') {
            return basePrompt + `
The user mentioned earlier that they've NEVER talked to ${conversationState.adult} about this before (first time).

Show summary and acknowledge:

"Here's what we have for your Whole Message:
â€¢ Observation: ${conversationState.observation_text_raw || 'not provided'}
â€¢ Thought: ${conversationState.thought_text_raw || 'not provided'}
â€¢ Feeling: ${conversationState.feeling_text_raw || 'not provided'}
â€¢ Want: ${conversationState.want_text_raw || 'not provided'}"

${conversationState.has_observation && conversationState.has_thought && conversationState.has_feeling && conversationState.has_want ? '' : 'This is a good start! Just know that the more details you can share with [adult], the better they\'ll be able to understand and help you.'}

Then say: "I see this is your first time bringing this up with your ${conversationState.adult}. Starting this conversation is often the hardest part, so it's normal to feel nervous."

Then immediately continue to Branch A tips.`;
          } else {
            return basePrompt + `
Show summary and ask if they've talked before:

"Here's what we have for your Whole Message:
â€¢ Observation: ${conversationState.observation_text_raw || 'not provided'}
â€¢ Thought: ${conversationState.thought_text_raw || 'not provided'}
â€¢ Feeling: ${conversationState.feeling_text_raw || 'not provided'}
â€¢ Want: ${conversationState.want_text_raw || 'not provided'}"

${conversationState.has_observation && conversationState.has_thought && conversationState.has_feeling && conversationState.has_want ? '' : 'This is a good start! Just know that the more details you can share with [adult], the better they\'ll be able to understand and help you.'}

Then ask: "Have you ever talked to your ${conversationState.adult} about this problem before?"

Wait for yes/no response.`;
          }
        }

        if (conversationState.step === 'ask_talked_before') {
          return basePrompt + `
User is answering whether they've talked to ${conversationState.adult} before.

Detect from their response:
- YES they've talked before: "yes", "yeah", "I have", "I tried", "we talked", "last time", etc.
- NO they haven't: "no", "never", "first time", "haven't", "nope", etc.

If YES: Ask "How did that conversation go?" and wait for response.
If NO: Go to Branch A (first time).`;
        }

        if (conversationState.step === 'ask_how_went') {
          return basePrompt + `
User is describing how their previous conversation went.

Detect from their response:
- WENT WELL: "good", "ok", "okay", "fine", "well", "they listened", "they helped", "it was alright"
- DIDN'T GO WELL: "bad", "poorly", "terrible", "they yelled", "dismissed me", "didn't listen", "shut me down", "got defensive", "made it worse", "ignored"

If WENT WELL: Go to Branch B1
If DIDN'T GO WELL: Go to Branch B2 with empathy`;
        }

        if (conversationState.step === 'branch_a_intro') {
          return basePrompt + `
BRANCH A: First time talking to ${conversationState.adult}

Say EXACTLY this:

"That's ok! Starting this conversation is often the hardest part, so it's normal to feel nervous. Here are some tips to help you prepare:
â€¢ Pick a calm moment to talk, when everyone is not busy. Choose a place you feel comfortable in.
â€¢ Plan out what you want to say and what you want from the conversation (we already did that!). Try writing it down
â€¢ Rehearse the conversation (with yourself or with a friend/someone you trust)
â€¢ Try your best to stay calm (we have a few lessons on this in the Coping with Stress and Emotions module)
â€¢ Be open-minded: you can't be sure how they will act, so be open to whatever might happen.

Do you want to see your script or get more tips?"

Wait for response:
- "script" / "see script" / "show me" â†’ go to script
- "tips" / "more" / "ok" / "sure" / any ambiguous response â†’ go to tips_during`;
        }

        if (conversationState.step === 'branch_b1_intro') {
          return basePrompt + `
BRANCH B1: Talked before and it went well

Say: "That's great to hear! It sounds like you have a good connection with your ${conversationState.adult}. Since you've already talked to them before and it went well, you probably know what to expect. Here are a few quick reminders:
â€¢ Pick a good moment again, just like last time
â€¢ Start by referencing your previous conversation: 'Remember when we talked about [topic]? I wanted to follow up...'
â€¢ Be clear about what you need this time
â€¢ Give them time to respond"

Then ask: "Do you want to see your script or review any other tips?"

Wait for response - if ambiguous, default to more tips.`;
        }

        if (conversationState.step === 'branch_b2_intro') {
          return basePrompt + `
BRANCH B2: Talked before and it didn't go well

Say with empathy: "I'm sorry it didn't go well last time. That must have been really discouraging. But I'm proud of you for being willing to try againâ€”that takes real courage.

Here are some tips for what to do differently this time:
â€¢ Be clear and open from the very beginning about what you want to talk about. Don't wait for them to guess.
â€¢ Plan exactly what you want from this conversation. Do you want advice? Support? Just someone to listen?
â€¢ Think about what didn't work last time and try a different approach - for example, if the timing was bad, pick a calm moment when they're not busy or stressed.

Do you want to see your script or get more tips?"

Wait for response:
- "script" / "see it" / "show me" / "ready" â†’ go to generate_script
- "tips" / "more" / "ok" / "sure" / any ambiguous response â†’ go to tips_during

IMPORTANT: Do NOT ask follow-up questions about how they want to approach it or brainstorm together. Just offer tips or script.`;
        }

        if (conversationState.step === 'tips_during') {
          return basePrompt + `
You MUST say EXACTLY this word-for-word:

"Some tips for having the conversation:
â€¢ Don't put it off. Often the hardest part is starting the conversation. You might never feel 100% ready, so just do it anyway.
â€¢ Be clear and open about what you want to talk about from the beginning. 'I need to tell you about a problem and I need your advice' or 'Can we talk about [blank]'
â€¢ Talk through your Whole Message: observation, thought, feeling, want
â€¢ Focus on how you feel and your thoughts
â€¢ Give your adult time to respond
â€¢ If you are struggling with the conversation, it is ok to take a break and collect your thoughts.

Do you want to see your script or get more tips?"

Wait for response:
- "script" â†’ go to script
- "tips" / "more" / "ok" â†’ go to handling_responses`;
        }

        if (conversationState.step === 'handling_responses') {
          return basePrompt + `
Say EXACTLY this:

"Here are some common bad responses you might face. Choose 1 to read more:

1. They minimize your problems or opinions
2. They feel hurt and make it about them
3. They make you feel guilty
4. They don't want to talk/are too busy

Just type the number you want to learn about."

Wait for user to choose 1, 2, 3, or 4.`;
        }

        if (conversationState.step === 'handling_response_1') {
          return basePrompt + `
Say EXACTLY this:

"They minimize your problems or opinions: This might happen when they think what you are going through is just 'childish problems' or 'normal teenage stuff'. Or they might dismiss your opinions, make jokes, or not take it seriously because of your age.

Even if your problem is typical for teenagers, it is still a problem you are struggling with and is important to you. Take the time to explain further or give examples of what you are struggling with and how it is affecting you. If you need help to convey your thoughts and ideas, consider presenting it differently using the Whole Message approach. Be clear that you did spend time thinking about this."

Then ask: "Want to read about another possible response, or are you ready to see your script?"`;
        }

        if (conversationState.step === 'handling_response_2') {
          return basePrompt + `
Say EXACTLY this:

"They make it about them: When you share that something is making you sad or disappointed, sometimes the adult might feel hurt or misunderstood. They might say something like 'Why are you blaming me? I did it because it's what's best for you.'

Rather than telling them what they need to change, focus on what you need help with to get better or feel better, and how they might help you to do that. This will make it easier for them to listen to and to understand that you are just trying to seek connections, not judgment."

Then ask: "Want to read about another possible response, or are you ready to see your script?"`;
        }

        if (conversationState.step === 'handling_response_3') {
          return basePrompt + `
Say EXACTLY this:

"They might try to make you feel guilty: They might try to make you feel guilty about somebody else's actions or about having a problem at all. For example, they could say 'You have a good life, a house, and food to eat, why would you feel unhappy?'

Explain that even though you have a 'good life', you are still unhappy and this is a sign something isn't right and that you need help."

Then ask: "Want to read about another possible response, or are you ready to see your script?"`;
        }

        if (conversationState.step === 'handling_response_4') {
          return basePrompt + `
Say EXACTLY this:

"They don't want to talk/are too busy: Sometimes adults are genuinely busy or stressed and can't have a deep conversation right then.

If this happens, try saying: 'I understand you're busy right now. When would be a good time for us to talk? This is really important to me.' Then schedule a specific time. Don't let it dropâ€”follow up with them."

Then ask: "Want to read about another possible response, or are you ready to see your script?"`;
        }

        if (conversationState.step === 'generate_script') {
          const isMentalHealth = conversationState.isMentalHealth;
          
          return basePrompt + `
Generate a natural conversation script for the user based on their Whole Message parts.

Create a script that sounds like a real teenager talking to an adult - natural, conversational, polite but not stiff.

Format:
"You can try saying something like:

[Create a natural, flowing script that incorporates their observation, thought, feeling, and want. Make it sound like actual spoken dialogue, not a formal letter. Use conversational transitions like "So...", "I wanted to talk to you about...", "The thing is..."]"

${isMentalHealth ? `
Then add these EXACT mental health tips:

"Since you want to talk to your ${conversationState.adult} about your mental health, here are a few extra things to keep in mind:
1. Find a quiet moment with no distractions, in a place you feel comfortable.
2. Be honest with how you feel, how it's affecting you and how long it's been. For example: Lately, maybe for the past month, all I want to do is stay in bed and sleep. I just feel so sad.
3. Sometimes, the adults might not realize that this information is meant to be kept just between you and them. It's ok to ask them to keep it a secret. For example: It's hard for me to talk about these feelings, and they are very personal to me. I would appreciate it if you would not share what I've told you with anyone else.
4. Sometimes, there are situations where keeping a secret may not be the best choice. Your safety is the utmost important.
5. Even though it can be hard to reach out, it's very important that you get the help and support you need."
` : ''}

After the script (and mental health tips if applicable), end with:

"Let me know if you want more tips on talking to adults! ðŸš€"

IMPORTANT: Make the script feel authentic and spoken, not written or formal.`;
        }

        return basePrompt;
      };

      const buildConversationHistory = (newMessage) => {
        const history = [];
        
        const recentMessages = messages.slice(-8);
        recentMessages.forEach(msg => {
          if (msg.type === 'user') {
            history.push({ role: 'user', content: msg.text });
          } else {
            history.push({ role: 'assistant', content: msg.text });
          }
        });
        
        history.push({ role: 'user', content: newMessage });
        
        return history;
      };

      const parseAndUpdateState = (botResponse, userMessage) => {
        const updates = {};
        const lowerUser = userMessage.toLowerCase();
        const lowerBot = botResponse.toLowerCase();

        // Global override: if user asks for script directly, give it to them
        if (lowerUser.includes('tell me what to say') || lowerUser.includes('just give me') || lowerUser.includes('give me the script')) {
          if (lowerBot.includes('you can try saying')) {
            return updates;
          }
          updates.step = 'generate_script';
          return updates;
        }

        // Mental health detection
        const mentalHealthKeywords = ['depressed', 'anxiety', 'anxious', 'self-harm', 'hurt myself', 'kill myself', 'suicide', 'suicidal', 'therapist', 'counselor', 'psychologist', 'mental health'];
        if (mentalHealthKeywords.some(kw => lowerUser.includes(kw))) {
          updates.isMentalHealth = true;
        }

        // Identification phase
        if (conversationState.step === 'welcome' || conversationState.step === 'identification') {
          const adultKeywords = ['teacher', 'mom', 'dad', 'parent', 'mother', 'father', 'brother', 'sister', 'principal', 'doctor', 'nurse', 'boss', 'cousin', 'aunt', 'uncle', 'grandma', 'grandpa', 'coach'];
          const foundAdult = adultKeywords.find(kw => lowerUser.includes(kw));
          if (foundAdult && !conversationState.adult) {
            updates.adult = foundAdult;
          }

          if (userMessage.length > 10 && !conversationState.problem_description) {
            updates.problem_description = userMessage;
            
            if (lowerUser.includes('grade') || lowerUser.includes('school') || lowerUser.includes('test') || lowerUser.includes('homework') || lowerUser.includes('bully')) {
              updates.problem_theme = 'school';
            } else if (lowerUser.includes('parent') || lowerUser.includes('mom') || lowerUser.includes('dad') || lowerUser.includes('family') || lowerUser.includes('sibling')) {
              updates.problem_theme = 'family';
            } else if (lowerUser.includes('friend') || lowerUser.includes('lonely')) {
              updates.problem_theme = 'friends';
            }
          }

          if ((updates.adult || conversationState.adult) && (updates.problem_description || conversationState.problem_description)) {
            if (lowerBot.includes('what happened')) {
              updates.step = 'initial_story';
            } else {
              updates.step = 'identification';
            }
          } else {
            updates.step = 'identification';
          }
        }

        // Initial story - detect parts AND if they've talked before
        if (conversationState.step === 'initial_story') {
          if (!conversationState.has_observation && userMessage.length > 20) {
            updates.has_observation = true;
            updates.observation_text_raw = userMessage;
          }

          // Detect if they've talked before
          const talkedBeforeKeywords = ['last time', 'when i talked', 'when i brought this up', 'previously', 'before when', 'already talked', 'we discussed'];
          const neverTalkedKeywords = ['never talked', 'first time', 'haven\'t talked', 'never brought this up', 'haven\'t mentioned'];
          
          if (!conversationState.talked_before_detected) {
            if (talkedBeforeKeywords.some(kw => lowerUser.includes(kw))) {
              updates.talked_before = 'yes';
              updates.talked_before_detected = true;
            } else if (neverTalkedKeywords.some(kw => lowerUser.includes(kw))) {
              updates.talked_before = 'no';
              updates.talked_before_detected = true;
            }
          }

          if (lowerBot.includes('what do you think') || lowerBot.includes('what\'s going through your mind')) {
            updates.step = 'collecting_thought';
          } else if (lowerBot.includes('how does this make you feel') || lowerBot.includes('how do you feel')) {
            updates.step = 'collecting_feeling';
          } else if (lowerBot.includes('what do you want to happen') || lowerBot.includes('what outcome')) {
            updates.step = 'collecting_want';
          } else if (lowerBot.includes('here\'s what we have') || lowerBot.includes('whole message')) {
            updates.step = 'show_summary';
          }
        }

        // Collecting parts - also check for talked_before mentions
        if (conversationState.step === 'collecting_thought') {
          const declined = lowerUser.includes('idk') || lowerUser.includes('i don\'t know') || lowerUser.includes('rather not');
          if (!declined && userMessage.length > 3) {
            updates.has_thought = true;
            updates.thought_text_raw = userMessage;
          }

          const talkedBeforeKeywords = ['last time', 'when i talked', 'when i brought this up', 'previously', 'before when'];
          const neverTalkedKeywords = ['never talked', 'first time', 'haven\'t talked', 'never brought this up'];
          
          if (!conversationState.talked_before_detected) {
            if (talkedBeforeKeywords.some(kw => lowerUser.includes(kw))) {
              updates.talked_before = 'yes';
              updates.talked_before_detected = true;
            } else if (neverTalkedKeywords.some(kw => lowerUser.includes(kw))) {
              updates.talked_before = 'no';
              updates.talked_before_detected = true;
            }
          }

          if (lowerBot.includes('how does this make you feel') || lowerBot.includes('how do you feel')) {
            updates.step = 'collecting_feeling';
          } else if (lowerBot.includes('what do you want')) {
            updates.step = 'collecting_want';
          } else if (lowerBot.includes('here\'s what we have')) {
            updates.step = 'show_summary';
          }
        }

        if (conversationState.step === 'collecting_feeling') {
          const declined = lowerUser.includes('idk') || lowerUser.includes('i don\'t know') || lowerUser.includes('rather not');
          if (!declined && userMessage.length > 2) {
            updates.has_feeling = true;
            updates.feeling_text_raw = userMessage;
          }

          if (lowerBot.includes('why do you feel') || lowerBot.includes('what makes you feel')) {
            updates.step = 'feeling_reasoning';
          } else if (lowerBot.includes('what do you want')) {
            updates.step = 'collecting_want';
          } else if (lowerBot.includes('here\'s what we have')) {
            updates.step = 'show_summary';
          }
        }

        if (conversationState.step === 'feeling_reasoning') {
          if (userMessage.length > 3) {
            updates.feeling_reasoning = userMessage;
          }

          if (lowerBot.includes('what do you want')) {
            updates.step = 'collecting_want';
          } else if (lowerBot.includes('here\'s what we have')) {
            updates.step = 'show_summary';
          }
        }

        if (conversationState.step === 'collecting_want') {
          const declined = lowerUser.includes('idk') || lowerUser.includes('i don\'t know') || lowerUser.includes('rather not');
          if (!declined && userMessage.length > 3) {
            updates.has_want = true;
            updates.want_text_raw = userMessage;
          }

          if (lowerBot.includes('here\'s what we have')) {
            updates.step = 'show_summary';
          }
        }

        if (conversationState.step === 'show_summary') {
          if (lowerBot.includes('have you ever talked') || lowerBot.includes('talked to your')) {
            updates.step = 'ask_talked_before';
          } else if (lowerBot.includes('how did that conversation go')) {
            updates.step = 'ask_how_went';
          } else if (lowerBot.includes('first time bringing this up') || lowerBot.includes('starting this conversation')) {
            updates.step = 'branch_a_intro';
            updates.branch = 'A';
          }
        }

        if (conversationState.step === 'ask_talked_before') {
          const saidYes = lowerUser.includes('yes') || lowerUser.includes('yeah') || lowerUser.includes('i have') || lowerUser.includes('we talked');
          const saidNo = lowerUser.includes('no') || lowerUser.includes('never') || lowerUser.includes('first time') || lowerUser.includes('haven\'t');
          
          if (saidYes) {
            updates.talked_before = 'yes';
            if (lowerBot.includes('how did that')) {
              updates.step = 'ask_how_went';
            }
          } else if (saidNo) {
            updates.talked_before = 'no';
            updates.step = 'branch_a_intro';
            updates.branch = 'A';
          }
        }

        if (conversationState.step === 'ask_how_went') {
          const wentWell = lowerUser.includes('good') || lowerUser.includes('ok') || lowerUser.includes('okay') || lowerUser.includes('fine') || lowerUser.includes('well') || lowerUser.includes('listened');
          const wentPoorly = lowerUser.includes('bad') || lowerUser.includes('poorly') || lowerUser.includes('terrible') || lowerUser.includes('yelled') || lowerUser.includes('dismissed') || lowerUser.includes('didn\'t listen') || lowerUser.includes('shut me down') || lowerUser.includes('ignored');
          
          if (wentWell) {
            updates.went_well = true;
            updates.step = 'branch_b1_intro';
            updates.branch = 'B1';
          } else if (wentPoorly) {
            updates.went_well = false;
            updates.step = 'branch_b2_intro';
            updates.branch = 'B2';
          }
        }

        if (conversationState.step === 'branch_a_intro' || conversationState.step === 'branch_b1_intro' || conversationState.step === 'branch_b2_intro') {
          const wantsScript = lowerUser.includes('script') || lowerUser.includes('see it') || lowerUser.includes('show me') || lowerUser.includes('ready');
          const wantsTips = lowerUser.includes('tips') || lowerUser.includes('more') || lowerUser.includes('ok') || lowerUser.includes('sure') || lowerUser.includes('yeah');
          
          if (wantsScript) {
            updates.step = 'generate_script';
          } else if (wantsTips || !wantsScript) {
            updates.step = 'tips_during';
            updates.shownTipsBefore = true;
          }
        }

        if (conversationState.step === 'tips_during') {
          const wantsScript = lowerUser.includes('script') || lowerUser.includes('see it') || lowerUser.includes('show me') || lowerUser.includes('ready');
          
          if (wantsScript) {
            updates.step = 'generate_script';
          } else {
            updates.step = 'handling_responses';
            updates.shownTipsDuring = true;
          }
        }

        if (conversationState.step === 'handling_responses') {
          if (lowerUser.includes('1') || lowerUser.includes('minimize')) {
            updates.step = 'handling_response_1';
          } else if (lowerUser.includes('2') || lowerUser.includes('hurt') || lowerUser.includes('about them')) {
            updates.step = 'handling_response_2';
          } else if (lowerUser.includes('3') || lowerUser.includes('guilt')) {
            updates.step = 'handling_response_3';
          } else if (lowerUser.includes('4') || lowerUser.includes('busy') || lowerUser.includes('don\'t want')) {
            updates.step = 'handling_response_4';
          }
        }

        if (conversationState.step === 'handling_response_1' || conversationState.step === 'handling_response_2' || 
            conversationState.step === 'handling_response_3' || conversationState.step === 'handling_response_4') {
          const wantsAnother = lowerUser.includes('another') || lowerUser.includes('more') || /^[1-4]$/.test(userMessage.trim());
          const wantsScript = lowerUser.includes('script') || lowerUser.includes('ready') || lowerUser.includes('see');
          
          if (wantsAnother) {
            updates.step = 'handling_responses';
          } else if (wantsScript) {
            updates.step = 'generate_script';
            updates.shownHandlingResponses = true;
          }
        }

        return updates;
      };

      return (
        <div className="flex flex-col h-screen bg-gradient-to-br from-blue-50 to-purple-50">
          <div className="bg-white shadow-sm border-b border-gray-200 p-4 flex justify-between items-center">
            <div>
              <h1 className="text-xl font-bold text-gray-800">Y-TALK - Conversation Buddy</h1>
              <p className="text-sm text-gray-500">Turn your thoughts into messages you can say to adults</p>
            </div>
            <button
              onClick={resetConversation}
              className="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm text-gray-700 transition-colors"
            >
              <RotateCcw size={16} />
              Start Over
            </button>
          </div>

          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.map((msg, idx) => (
              <div
                key={idx}
                className={`flex items-end gap-2 ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                {msg.type === 'bot' && (
                  <img
                    src="./bot-avatar.jpg"
                    alt="Bot Avatar"
                    className="w-10 h-10 rounded-full shadow-sm border border-gray-200 flex-shrink-0"
                  />
                )}

                <div
                  className={`max-w-[75%] rounded-2xl px-4 py-3 ${
                    msg.type === 'user'
                      ? 'bg-blue-500 text-white'
                      : 'bg-white text-gray-800 shadow-sm'
                  }`}
                >
                  <p className="whitespace-pre-wrap" dangerouslySetInnerHTML={{
                    __html: msg.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                  }}></p>
                </div>

                {msg.type === 'user' && (
                  <img
                    src="./user-avatar.jpg"
                    alt="User Avatar"
                    className="w-10 h-10 rounded-full shadow-sm border border-gray-200 flex-shrink-0"
                  />
                )}
              </div>
            ))}
            
            {isLoading && (
              <div className="flex justify-start">
                <div className="bg-white rounded-2xl px-4 py-3 shadow-sm">
                  <div className="flex gap-1">
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                  </div>
                </div>
              </div>
            )}
            
            <div ref={messagesEndRef} />
          </div>

          <div className="bg-white border-t border-gray-200 p-4">
            <div className="flex gap-2">
              <input
                ref={inputRef}
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                placeholder="Type your message..."
                className="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                disabled={isLoading}
              />
              <button
                onClick={handleSend}
                disabled={isLoading || !input.trim()}
                className="px-6 py-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
              >
                <Send size={20} />
              </button>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<ConversationCoach />, document.getElementById('root'));
  </script>
</body>
</html>
